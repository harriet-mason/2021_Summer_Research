---
title: "Find Features Stuff"
author: "Harriet Mason"
date: "04/02/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, loadlibraries}
library(tidyverse)
library(cassowaryr)
library(tourr)
library(ferrn)
library(stringr)
```


# Feature Vs Noise
## Simulate Data
```{r}
# set seed
set.seed(2020)

# get L-shape data
lshape <- features %>% 
  filter(feature=="l-shape")

# make tibble group a
feature_vs_noise_A <- tibble(x1 = 2.5* cassowaryr:::unitize(lshape$x),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(lshape$y),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("A",100)
                           )

# Make tibble group b
feature_vs_noise_B <- tibble(x1 = rnorm(100, 0.5, 1),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = rnorm(100, 0.5, 1),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("B",100)
                           )


# combine tibbles
feature_vs_noise <- bind_rows(feature_vs_noise_A, feature_vs_noise_B)

# final tibble and ggpairs check
GGally::ggpairs(feature_vs_noise, columns = c(1:5),
                ggplot2::aes(colour = group, alpha=0.5))

```
## Calculate Scagnostics
```{r}
# calculate scagnostics
scags_feature_vs_noise_A <- calc_scags_wide(feature_vs_noise_A[,1:5]) %>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="A_value")

scags_feature_vs_noise_B <- calc_scags_wide(feature_vs_noise_B[,1:5])%>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="B_value")

# Combine Data
scags_feature_vs_noise_dif <- scags_feature_vs_noise_A %>%
  left_join(scags_feature_vs_noise_B) %>%
  mutate(dif_value = abs(A_value - B_value))

```
## Try Projection Persuit
Top differences were in convex, skinny, monotonic, and outlying

```{r, old functions remove when new ones are working}
skinny_group <- function(cl){
  classes <- unique(cl)
  function(mat){
    #each matrix group
    group1 <- mat[which(cl==classes[1]),]
    group2 <- mat[which(cl==classes[2]),]
  
    #scag value
    val1 <- sc_skinny(x = group1[,1], y = group1[,2])
    val2 <- sc_skinny(x = group2[,1], y = group2[,2])
    
    #final value
    abs(val1-val2)
  }
}

# Save Tour Function
save_tourr <- function(numeric_data, group_vector, scag, search, filename){
  indx <- list(
    "convex" = convex_group(group_vector),
    "skinny" = skinny_group(group_vector)
  )
  srch <- list(
    "geo" = search_geodesic,
    "bet" = search_better,
    "bet_rand" = search_better_random
  )
  h <- save_history(numeric_data,
                    tour_path = guided_tour(indx[[scag]], d=2, 
                                            search_f =  srch[[search]]))
  saveRDS(h, file=filename)
}

save_tourr <- function(numeric_data, group_vector, scag, search, seed, delta_alpha, filename, ...){
  # old function tested
  srch <- list(
    "geo" = search_geodesic,
    "bet" = search_better,
    "bet_rand" = search_better_random
  )
  set.seed(seed)
  h <- save_history(numeric_data,
                    tour_path = guided_tour(scags_groups(group_vector, scag), 
                                            d=2, 
                                            search_f =  srch[[search]],
                                            ...))
  saveRDS(h, file=filename)
}
  
```

```{r, Functions and Grid Search}
# Scag Projection Persuit index
scags_groups <- function(cl, scag){
  classes <- unique(cl)
  function(mat){
    #each matrix group
    group1 <- mat[which(cl==classes[1]),]
    group2 <- mat[which(cl==classes[2]),]
    
    indx <- list( #copy and pasting should be cleaned up
      "convex" = (sc_convex(x = group1[,1], y = group1[,2]) - sc_convex(x = group2[,1], y = group2[,2])),
      "monotonic" = (sc_monotonic(x = group1[,1], y = group1[,2]) - sc_monotonic(x = group2[,1], y = group2[,2])),
      "outlying" = (sc_outlying(x = group1[,1], y = group1[,2]) - sc_outlying(x = group2[,1], y = group2[,2])),
      "skinny" = (sc_skinny(x = group1[,1], y = group1[,2]) - sc_skinny(x = group2[,1], y = group2[,2]))
      )
    
    #final value
    abs(indx[[scag]])
  }
}

# Save Tour Function 
save_tourr <- function(numeric_data, group_vector, scag, search, seed, delta_alpha, filename, ...){
  srch <- list(
    "geo" = save_history(numeric_data, tour_path = guided_tour(scags_groups(group_vector, scag), d=2, 
                                                               search_f =  search_geodesic,
                                                               delta = delta_alpha,
                                                               ...)),
    "bet" = save_history(numeric_data, tour_path = guided_tour(scags_groups(group_vector, scag), d=2, 
                                                               search_f =  search_better,
                                                               alpha = delta_alpha,
                                                               ...)),
    "bet_rand" = save_history(numeric_data, tour_path = guided_tour(scags_groups(group_vector, scag), d=2, 
                                                               search_f =  search_better_random,
                                                               alpha = delta_alpha,
                                                               ...))
  )
  set.seed(seed)
  h <- srch[[search]]
  saveRDS(h, file=filename)
}

  #example
save_tourr(feature_vs_noise[1:5], feature_vs_noise$group, "monotonic", "geo", "goodvibes.rds", delta_alpha=0.1)

# Tour grid Function
grid_tourr <- function(numeric_data, group_vector, scags, searches, seeds, delta_alpha, ...){
  expand.grid(scags, searches, seeds, delta_alpha, stringsAsFactors=FALSE) %>%
    mutate(filename = paste("features_data/tours/tour", Var1, Var2, Var4, Var3, ".rds", sep="_")) %>%
    group_by(Var1, Var2, Var4, Var3) %>%
    summarise(save_tourr(numeric_data, group_vector, scag = Var1,  search = Var2, seed = Var3, 
                         delta_alpha = Var4, filename = filename))
}
#example
grid_tourr(numeric_data = feature_vs_noise[1:5], 
           group_vector = feature_vs_noise$group,
           scags = c("convex", "skinny"), 
           #scags = c("convex", "skinny", "outlying", "monotonic"), 
           searches = c("geo", "bet", "bet_rand"), 
           seeds = seq(5), 
           delta_alpha = c(0.05, 0.1, 0.5, 0.7, 1)) 

```

````{r, Save and Trace which dont quite work}
# Animate Tour Function
anim_tourr <- function(numeric_data, group_vector, saved_tour, filename){
  a <- animate_xy(numeric_data,
                  tour_path = planned_tour(saved_tour),
                  col = group_vector)
  #saveRDS(a, filename)
}

#example
filename <- readRDS("features_data/tours/tour_convex_geo_0.1_1_.rds")
anim_tourr(feature_vs_noise[1:5], feature_vs_noise$group, filename)

```

```{r}
t1 <- save_history(flea[, 1:6], max = 3)
a <- animate_xy(flea[, 1:6], planned_tour(t1))

b <- animate_xy(feature_vs_noise[1:5],
                tour_path = guided_tour(scags_groups(feature_vs_noise$group, "convex")),
                col = feature_vs_noise$group)

c <- animate(feature_vs_noise[1:5],
                tour_path = planned_tour(goodvibes),
                col = feature_vs_noise$group)

d <- animate_xy(feature_vs_noise[1:5], max = 30,
             col = feature_vs_noise$group)


saveRDS(c, "badvibes.rds")

# Tour Trace Plot Function
trace_plot <- function(saved_anim, plot_name, filename){
  p <- saved_anim %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("plotname"))
  ggsave(filename, p)
}

#example
badvibes <- readRDS("C:/Users/harri/OneDrive/2021_Summer_Research/badvibes.rds")
trace_plot(c, "Vibes Plot Check", "neutralvibes.jpg")


```

```{r, Convex}
# make index function
convex_group <- function(cl){
  classes <- unique(cl)
  function(mat){
    #each matrix group
    group1 <- mat[which(cl==classes[1]),]
    group2 <- mat[which(cl==classes[2]),]
  
    #scag value
    val1 <- sc_convex(x = group1[,1], y = group1[,2])
    val2 <- sc_convex(x = group2[,1], y = group2[,2])
    
    #final value
    abs(val1-val2)
  }
}

#

# try searches
#try geo search 5 times for convex
for (i in seq(5)){
  set.seed(i)
  #tour
  convex_geodesic <- animate_xy(feature_vs_noise[1:5],
                                tour_path = guided_tour(convex_group(feature_vs_noise$group)),
                                #max.tries=10,
                                delta=1,
                                col = feature_vs_noise$group)
  #save tour path
  saveRDS(convex_geodesic, paste("features_data/tours/tour_convex_geodesic_", i, ".rds",
                                 sep=""))
  # trace plot
  p <- convex_geodesic %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("Convex: Feature vs Noise, seed", i))
  # save trace plot
  ggsave(paste("features_data/trace_plots/trace_convex_geodesic_", i, ".png", sep=""), p)
}


#try better search, 5 times
for (i in seq(5)){
  set.seed(i)
  #tour
  convex_better <- animate_xy(feature_vs_noise[1:5],
                              tour_path = guided_tour(convex_group(feature_vs_noise$group),
                                                      d=2,
                                                      alpha=2,
                                                      search_f = search_better),
                              col = feature_vs_noise$group)
  #save tour path
  saveRDS(convex_better, paste("features_data/tours/tour_convex_better_", i, ".rds",
                                 sep=""))
  # trace plot
  p <- convex_better %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("Feature vs Noise: Convex/Better/Seed_", i))
  # save trace plot
  ggsave(paste("features_data/trace_plots/fvsn_convex_better_", i, ".png", sep=""), p)
}

#try better_random search, 5 times
for (i in seq(5)){
  set.seed(i)
  #tour
  convex_better_random <- animate_xy(feature_vs_noise[1:5],
                              tour_path = guided_tour(convex_group(feature_vs_noise$group),
                                                      d=2,
                                                      alpha=0.3,
                                                      search_f = search_better_random),
                              col = feature_vs_noise$group)
  #save tour path
  saveRDS(convex_better_random, paste("features_data/tours/tour_convex_better_random_", i, ".rds",
                                 sep=""))
  # trace plot
  p <- convex_better_random %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("Feature vs Noise: Convex/better_random/Seed_", i))
  # save trace plot
  ggsave(paste("features_data/trace_plots/fvsn_convex_better_random_", i, ".png", sep=""), p)
}
```


```{r, Skinny}
# make index function
skinny_group <- function(cl){
  classes <- unique(cl)
  function(mat){
    #each matrix group
    group1 <- mat[which(cl==classes[1]),]
    group2 <- mat[which(cl==classes[2]),]
  
    #scag value
    val1 <- sc_skinny(x = group1[,1], y = group1[,2])
    val2 <- sc_skinny(x = group2[,1], y = group2[,2])
    
    #final value
    abs(val1-val2)
  }
}

# try searches
#try geo search 10 times for skinny
for (i in seq(5)){
  set.seed(i)
  #tour
  skinny_geodesic <- animate_xy(feature_vs_noise[1:5],
                                tour_path = guided_tour(skinny_group(feature_vs_noise$group)),
                                #max.tries=10,
                                delta=1,
                                col = feature_vs_noise$group)
  #save tour path
  saveRDS(skinny_geodesic, paste("features_data/tours/tour_skinny_geodesic_", i, ".rds",
                                 sep=""))
  # trace plot
  p <- skinny_geodesic %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("skinny: Feature vs Noise, seed", i))
  # save trace plot
  ggsave(paste("features_data/trace_plots/trace_skinny_geodesic_", i, ".png", sep=""), p)
}


#try better search, 10 times
for (i in seq(5)){
  set.seed(i)
  #tour
  skinny_better <- animate_xy(feature_vs_noise[1:5],
                              tour_path = guided_tour(skinny_group(feature_vs_noise$group)),
                              search_f = search_better,
                              #max.tries=10,
                              delta=1,
                              col = feature_vs_noise$group)
  #save tour path
  saveRDS(skinny_better, paste("features_data/tours/tour_skinny_better_", i, ".rds",
                                 sep=""))
  # trace plot
  p <- skinny_better %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("Feature vs Noise: skinny/Better/Seed_", i))
  # save trace plot
  ggsave(paste("features_data/trace_plots/fvsn_skinny_better_", i, ".png", sep=""), p)
}

#try better_random search, 10 times
for (i in seq(5)){
  set.seed(i)
  #tour
  skinny_better_random <- animate_xy(feature_vs_noise[1:5],
                              tour_path = guided_tour(skinny_group(feature_vs_noise$group)),
                              search_f = search_better_random,
                              #max.tries=10,
                              delta=1,
                              col = feature_vs_noise$group)
  #save tour path
  saveRDS(skinny_better_random, paste("features_data/tours/tour_skinny_better_random_", i, ".rds",
                                 sep=""))
  # trace plot
  p <- skinny_better_random %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("Feature vs Noise: skinny/better_random/Seed_", i))
  # save trace plot
  ggsave(paste("features_data/trace_plots/fvsn_skinny_better_random_", i, ".png", sep=""), p)
}
```

```{r, Outlying}

```


# Feature Vs Feature
## Simulate Data
```{r}
# set seed
set.seed(2021)

# get L-shape data
lshape <- features %>% 
  filter(feature=="l-shape")

nonlinear <- features %>% 
  filter(feature=="nonlinear2")

# make tibble group a
feature_vs_feature_A <- tibble(x1 = 2.5* cassowaryr:::unitize(lshape$x),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(lshape$y),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("A",100)
                           )

# Make tibble group b
feature_vs_feature_B <- tibble(x1 = 2.5* cassowaryr:::unitize(nonlinear$x),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(nonlinear$y),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("B",100)
                           )


# combine tibbles
feature_vs_feature <- bind_rows(feature_vs_feature_A, feature_vs_feature_B)

# final tibble and ggpairs check
GGally::ggpairs(feature_vs_feature, columns = c(1:5),
                ggplot2::aes(colour = group, alpha=0.5))

```

## Calculate Scagnostics
```{r}
# calculate scagnostics
scags_feature_vs_feature_A <- calc_scags_wide(feature_vs_feature_A[,1:5]) %>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="A_value")

scags_feature_vs_feature_B <- calc_scags_wide(feature_vs_feature_B[,1:5])%>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="B_value")

# Combine Data
scags_feature_vs_feature_dif <- scags_feature_vs_feature_A %>%
  left_join(scags_feature_vs_feature_B) %>%
  mutate(dif_value = abs(A_value - B_value))
```
## Try Projection Persuit
Top differences were in splines, monotonic, and outlying
```{r, Splines}
```

```{r, monotonic}
```

```{r, outlying}
```


# Multiple Features Vs Noise
## Simulate Data
```{r}
# set seed
set.seed(2022)

# get L-shape data
lshape <- features %>% 
  filter(feature=="l-shape")

nonlinear <- features %>% 
  filter(feature=="nonlinear2")

# make tibble group a
mfeatures_vs_noise_A <- tibble(x1 = 2.5* cassowaryr:::unitize(lshape$x),
                           x2 = 2.5* cassowaryr:::unitize(nonlinear$x),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(lshape$y),
                           x5 = 2.5* cassowaryr:::unitize(nonlinear$y),
                           group = rep("A",100)
                           )

# Make tibble group b
mfeatures_vs_noise_B <- tibble(x1 = rnorm(100, 0.5, 1),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = rnorm(100, 0.5, 1),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("B",100)
                           )


# combine tibbles
mfeatures_vs_noise <- bind_rows(mfeatures_vs_noise_A, mfeatures_vs_noise_B)

# final tibble and ggpairs check
GGally::ggpairs(mfeatures_vs_noise, columns = c(1:5),
                ggplot2::aes(colour = group, alpha=0.5))

```
## Calculate Scagnostics
```{r}
# calculate scagnostics
scags_mfeatures_vs_noise_A <- calc_scags_wide(mfeatures_vs_noise_A[,1:5]) %>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="A_value")

scags_mfeatures_vs_noise_B <- calc_scags_wide(mfeatures_vs_noise_B[,1:5])%>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="B_value")

# Combine Data
scags_mfeatures_vs_noise_dif <- scags_mfeatures_vs_noise_A %>%
  left_join(scags_mfeatures_vs_noise_B) %>%
  mutate(dif_value = abs(A_value - B_value))
```

## Try Projection Persuit
Top differences were:
1) x1 vs x2: splines and dcor
2) x1 vs x4: convex
```{r, splines}
```

```{r, dcor}
```

```{r, convex}
```
