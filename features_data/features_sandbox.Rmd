---
title: "Find Features Stuff"
author: "Harriet Mason"
date: "04/02/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, loadlibraries}
library(tidyverse)
library(cassowaryr)
library(tourr)
library(ferrn)
library(stringr) 
```


# Feature Vs Noise
## Simulate Data
```{r}
# set seed
set.seed(2020)

# get L-shape data
lshape <- features %>% 
  filter(feature=="l-shape")

# make tibble group a
feature_vs_noise_A <- tibble(x1 = 2.5* cassowaryr:::unitize(lshape$x),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(lshape$y),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("A",100)
                           )

# Make tibble group b
feature_vs_noise_B <- tibble(x1 = rnorm(100, 0.5, 1),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = rnorm(100, 0.5, 1),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("B",100)
                           )


# combine tibbles
feature_vs_noise <- bind_rows(feature_vs_noise_A, feature_vs_noise_B)

# final tibble and ggpairs check
GGally::ggpairs(feature_vs_noise, columns = c(1:5),
                ggplot2::aes(colour = group, alpha=0.5))

```

## Calculate Scagnostics
```{r}
# calculate scagnostics
scags_feature_vs_noise_A <- calc_scags_wide(feature_vs_noise_A[,1:5]) %>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="A_value")

scags_feature_vs_noise_B <- calc_scags_wide(feature_vs_noise_B[,1:5])%>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="B_value")

# Combine Data
scags_feature_vs_noise_dif <- scags_feature_vs_noise_A %>%
  left_join(scags_feature_vs_noise_B) %>%
  mutate(dif_value = abs(A_value - B_value))

```

## Try Projection Persuit
Top differences were in convex, skinny, monotonic, and outlying

```{r, Projection Persuit Functions}
# Scag Projection Persuit index
scags_groups <- function(cl, scag){
  classes <- unique(cl)
  function(mat){
    #each matrix group
    group1 <- mat[which(cl==classes[1]),]
    group2 <- mat[which(cl==classes[2]),]
    
    indx <- list( #copy and pasting should be cleaned up
      "convex" = (sc_convex(x = group1[,1], y = group1[,2]) - sc_convex(x = group2[,1], y = group2[,2])),
      "monotonic" = (sc_monotonic(x = group1[,1], y = group1[,2]) - sc_monotonic(x = group2[,1], y = group2[,2])),
      "outlying" = (sc_outlying(x = group1[,1], y = group1[,2]) - sc_outlying(x = group2[,1], y = group2[,2])),
      "splines" = (sc_splines(x = group1[,1], y = group1[,2]) - sc_splines(x = group2[,1], y = group2[,2])),
      "skinny" = (sc_skinny(x = group1[,1], y = group1[,2]) - sc_skinny(x = group2[,1], y = group2[,2]))
      )
    
    #final value
    abs(indx[[scag]])
  }
}

# Save Tour Function 
save_tourr <- function(numeric_data, group_vector, scag, search, seed, alpha, max.tries, filename, ...){
  #set seed
  set.seed(seed)
  
  srch <- list(
    "bet" = save_history(numeric_data, tour_path = guided_tour(scags_groups(group_vector, scag), 
                                                               d=2, 
                                                               search_f =  search_better,
                                                               alpha = alpha,
                                                               max.tries = max.tries,
                                                               ...)),
    "bet_rand" = save_history(numeric_data, tour_path = guided_tour(scags_groups(group_vector, scag),
                                                                    d=2,
                                                                    search_f =  search_better_random,
                                                                    alpha = alpha,
                                                                    max.tries = max.tries,
                                                                    ...))
  )
  h <- srch[[search]]
  saveRDS(h, file=filename)
}

# Tour grid Function
grid_tourr <- function(numeric_data, group_vector, scags, searches, seeds, alpha, max.tries, filestart, ...){
  #make expanded tibble so that we can search a grid of values
  expand.grid(scags, searches, seeds, alpha, max.tries, stringsAsFactors=FALSE) %>%
    # add file names for saving
    mutate(filename = paste(filestart, Var1, Var2, Var4, Var5, Var3, ".rds", sep="_")) %>%
    # group by and summarise to run save on every value
    group_by(Var1, Var2, Var4, Var5, Var3) %>%
    summarise(save_tourr(numeric_data, group_vector, scag = Var1,  search = Var2, seed = Var3, 
                         alpha = Var4, max.tries=Var5, filename = filename))
}


# Animate Tour Function
anim_tourr <- function(numeric_data, group_vector, scag, search, seed, alpha, filestart){
  #set seed
  set.seed(seed)
  
  # perform search by calling function from list
  srch <- list(
    "bet" =  animate_xy(numeric_data,
                  tour_path = guided_tour(scags_groups(group_vector, scag),
                                          search_f = search_better),
                  col = group_vector),
    "bet_rand" = animate_xy(numeric_data,
                  tour_path = guided_tour(scags_groups(group_vector, scag),
                                          search_f = search_better_random),
                  col = group_vector)
    )
  
  #save object and file name
  a <- srch[[search]]
  filename <- paste(filestart, scag, search, alpha, seed, ".rds", sep="_")
  
  # save r object
  saveRDS(a, filename)
}

# Trace Plot Function
trace_plot <- function(saved_anim, plot_name, filename){
  p <- saved_anim %>%
    explore_trace_interp() + 
    scale_color_continuous_botanical() + 
    ggtitle(paste("plotname"))
  ggsave(filename, p)
}

# Polish function

```

````{r, Function Tests}
#save_tourr test
save_tourr(feature_vs_noise[1:5], feature_vs_noise$group, "convex", "bet", seed=1, alpha=1, max.tries = 25,
           filename = "features_data/tours/tour_convex_bet_1_25_1_.rds")

# grid search test
grid_tourr(numeric_data = feature_vs_noise[1:5], 
           group_vector = feature_vs_noise$group,
           scags = c("convex"), 
           searches = c("bet"), 
           seeds = 1, 
           alpha = 0.4,
           max.tries = 100,
           filestart = "features_data/tours/tour")


# anim_tourr test
anim_tourr(feature_vs_noise[1:5], feature_vs_noise$group, "convex", "bet", seed=1, 
           alpha=0.5, filestart = 'features_data/anims/anim')

# Test Polish


# Trace plot test

```

```{r, Grid Values, FvN}
filestart <- "features_data/tours/tour"
# First Set of Overnight Values (Convex & Skinny)
grid_tourr(numeric_data = feature_vs_noise[1:5], 
           group_vector = feature_vs_noise$group,
           scags = c("convex", "skinny"), 
           searches = c("bet", "bet_rand"), 
           seeds = seq(5), 
           alpha = c(0.05, 0.1, 0.5, 0.7, 1),
           max.tries = 25,
           filestart = filestart) 
# Second Set of Overnight Values (Monotonic and Outlying)
grid_tourr(numeric_data = feature_vs_noise[1:5], 
           group_vector = feature_vs_noise$group,
           scags = c("outlying", "monotonic"), 
           searches = c("bet", "bet_rand"), 
           seeds = seq(5), 
           alpha = c(0.1, 0.5, 0.7, 1),
           max.tries = 25,
           filestart = filestart) 
# (Convex and Skinny)
grid_tourr(numeric_data = feature_vs_noise[1:5], 
           group_vector = feature_vs_noise$group,
           scags = c("convex", "skinny"), 
           searches = c("bet", "bet_rand"), 
           seeds = seq(5), 
           alpha = c(0.45, 0.55, 0.6, 0.65, 0.75),
           max.tries = 25,
           filestart = filestart)

# Adjust Max Size Grid Search 
grid_tourr(numeric_data = feature_vs_noise[1:5], 
           group_vector = feature_vs_noise$group,
           scags = c("convex", "skinny"), #convex and skinny were the best of the scagnsotics
           searches = "bet",  #better was the better search lol
           seeds = seq(10), #increase number of seeds to increase certainty
           alpha = c(0.1, 0.3, 0.5, 0,7), #can have a lower alpha with higher max.tries
           max.tries = c(50, 100, 200, 300, 500), #test max tries
           filestart = "features_data/tours1/tour") #new folder so not with others

```

```{r, Working Examples for animate_xy}
# GEODESIC WORK
set.seed(2)
m <- animate_xy(feature_vs_noise[1:5],
                tour_path = guided_tour(scags_groups(feature_vs_noise$group, "convex")),
                delta=0.05,
                col = feature_vs_noise$group)
 # BETTER WORK
set.seed(7)
m <- animate_xy(feature_vs_noise[1:5],
                tour_path = guided_tour(scags_groups(feature_vs_noise$group, "convex"),
                                        search_f = search_better,
                                        alpha=0.75),
                col = feature_vs_noise$group)

# Anim_tour version of better work that does not produce the same results
anim_tourr(feature_vs_noise[1:5], feature_vs_noise$group, "convex", "bet", seed=7, 
           alpha=0.75, filestart = 'features_data/anims/anim')
```

# Feature Vs Feature
## Simulate Data
```{r}
# set seed
set.seed(2021)

# get L-shape data
lshape <- features %>% 
  filter(feature=="l-shape")

nonlinear <- features %>% 
  filter(feature=="nonlinear2")

# make tibble group a
feature_vs_feature_A <- tibble(x1 = 2.5* cassowaryr:::unitize(lshape$x),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(lshape$y),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("A",100)
                           )

# Make tibble group b
feature_vs_feature_B <- tibble(x1 = 2.5* cassowaryr:::unitize(nonlinear$x),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(nonlinear$y),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("B",100)
                           )


# combine tibbles
feature_vs_feature <- bind_rows(feature_vs_feature_A, feature_vs_feature_B)

# final tibble and ggpairs check
GGally::ggpairs(feature_vs_feature, columns = c(1:5),
                ggplot2::aes(colour = group, alpha=0.5))

```

## Calculate Scagnostics
```{r}
# calculate scagnostics
scags_feature_vs_feature_A <- calc_scags_wide(feature_vs_feature_A[,1:5]) %>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="A_value")

scags_feature_vs_feature_B <- calc_scags_wide(feature_vs_feature_B[,1:5])%>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="B_value")

# Combine Data
scags_feature_vs_feature_dif <- scags_feature_vs_feature_A %>%
  left_join(scags_feature_vs_feature_B) %>%
  mutate(dif_value = abs(A_value - B_value))
```

## Try Projection Persuit
Top differences were in splines, monotonic, and outlying
```{r, Grid Search FvF}
# (Convex and Skinny)
grid_tourr(numeric_data = feature_vs_feature[1:5], 
           group_vector = feature_vs_feature$group,
           scags = c("splines", "monotonic", "outlying"), 
           searches = c("bet", "bet_rand"), 
           seeds = seq(5), 
           alpha = c(0.1, 0.45, 0.55, 0.5, 0.6, 0.65, 0.7, 0.75, 1))

```



# Multiple Features Vs Noise
## Simulate Data
```{r}
# set seed
set.seed(2022)

# get L-shape data
lshape <- features %>% 
  filter(feature=="l-shape")

nonlinear <- features %>% 
  filter(feature=="nonlinear2")

# make tibble group a
mfeatures_vs_noise_A <- tibble(x1 = 2.5* cassowaryr:::unitize(lshape$x),
                           x2 = 2.5* cassowaryr:::unitize(nonlinear$x),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = 2.5* cassowaryr:::unitize(lshape$y),
                           x5 = 2.5* cassowaryr:::unitize(nonlinear$y),
                           group = rep("A",100)
                           )

# Make tibble group b
mfeatures_vs_noise_B <- tibble(x1 = rnorm(100, 0.5, 1),
                           x2 = rnorm(100, 0.5, 1),
                           x3 = rnorm(100, 0.5, 1),
                           x4 = rnorm(100, 0.5, 1),
                           x5 = rnorm(100, 0.5, 1),
                           group = rep("B",100)
                           )


# combine tibbles
mfeatures_vs_noise <- bind_rows(mfeatures_vs_noise_A, mfeatures_vs_noise_B)

# final tibble and ggpairs check
GGally::ggpairs(mfeatures_vs_noise, columns = c(1:5),
                ggplot2::aes(colour = group, alpha=0.5))

```
## Calculate Scagnostics
```{r}
# calculate scagnostics
scags_mfeatures_vs_noise_A <- calc_scags_wide(mfeatures_vs_noise_A[,1:5]) %>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="A_value")

scags_mfeatures_vs_noise_B <- calc_scags_wide(mfeatures_vs_noise_B[,1:5])%>%
  pivot_longer(cols=3:13, names_to = "scag", values_to="B_value")

# Combine Data
scags_mfeatures_vs_noise_dif <- scags_mfeatures_vs_noise_A %>%
  left_join(scags_mfeatures_vs_noise_B) %>%
  mutate(dif_value = abs(A_value - B_value))
```

## Try Projection Persuit
Top differences were:
1) x1 vs x2: splines and dcor
2) x1 vs x4: convex

# Watching the Tours

```{r}
# watch tour
# format: tour_scag_search_alpha_maxtries_seed_.rds
saved_tour <- NULL
saved_tour <- readRDS("features_data/tours1/tour_skinny_bet_7_500_5_.rds")
animate_xy(feature_vs_noise[1:5], 
        tour_path = planned_tour(saved_tour),
        col = feature_vs_noise$group)

```

# Polish Function Test
```{r}
saved_tour <- readRDS("features_data/tours/tour_convex_bet_0.3_300_4_.rds")
attr(saved_tour, "class") <- NULL
best_proj <- saved_tour[, , dim(saved_tour)[3]]

# RUN POLISH
animate_xy(
  feature_vs_noise[1:5],
  guided_tour(scags_groups(feature_vs_noise$group, "convex"),
    search_f = search_polish,
    cur_index = 0
  ),
  start = best_proj,
  col = feature_vs_noise$group
)

# TRY WITH SAVE TOUR
set.seed(2)
saved_tour2 <- save_history(feature_vs_noise[1:5],
             tour_path = guided_tour(scags_groups(feature_vs_noise$group, "convex"),
                                     search_f = search_polish,
                                     #polish_max_tries = 100,
                                     cur_index = 0),
             start = best_proj)

animate_xy(feature_vs_noise[1:5], 
        tour_path = planned_tour(saved_tour2),
        col = feature_vs_noise$group)

save_polish <- function(){
  
}

save_polish

```
